---

#- name: list docker containers
#  hosts: docker
#  tasks:
#  - community.docker.docker_host_info:
#      images: yes
#    register: result
#
#  - ansible.builtin.debug:
#      var: result.host_info

- name: install portainer_agent
  hosts: raspberrypi.thunderweb.co.uk , topcat.thunderweb.co.uk
  gather_facts: false
  tasks:
  - community.docker.docker_container:
      name: portainer_agent
      image: portainer/agent
      restart_policy: always
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - /var/lib/docker/volumes:/var/lib/docker.volumes
      ports:
        - 9001:9001

- name: install cloudflared on pi
  hosts: raspberrypi.thunderweb.co.uk
  gather_facts: false
  tasks:
  - community.docker.docker_container:
      name: cloudflared
      image: visibilityspots/cloudflared:latest
      network_mode: host
      restart_policy: always

- name: install shlink on topcat
  hosts: topcat.thunderweb.co.uk
  gather_facts: false
  tasks:
  - community.docker.docker_container:
      name: shlink
      image: shlinkio/shlink:stable
      restart_policy: always
      ports:
        - "127.0.0.1:8080:8080"
      env:
        DEFAULT_DOMAIN: "yag.me.uk"
        IS_HTTPS_ENABLED: "true"
        DB_DRIVER: "mysql"
        DB_USER: "shlink"
        DB_PASSWORD: "***REMOVED***"
        DB_NAME: "shlink"
        DB_HOST: "topcat.thunderweb.co.uk"
        GEOLITE_LICENSE_KEY: "***REMOVED***"

- name: install gitlab on topcat
  hosts: topcat.thunderweb.co.uk
  gather_facts: false
  tasks:
  - community.docker.docker_container:
      name: gitlab
      image: gitlab/gitlab-ce:latest
      hostname: gitlab.thunderweb.co.uk
      restart_policy: always
      volumes:
        - gitlab_config:/etc/gitlab
        - gitlab_logs:/var/log/gitlab
        - gitlab_data:/var/opt/gitlab
      ports:
        - "127.0.0.1:9080:80"
        - "2222:22"

- name: install check_mk on topcat
  hosts: topcat.thunderweb.co.uk
  gather_facts: false
  tasks:
    - community.docker.docker_container:
        name: monitoring
        image: checkmk/check-mk-raw:2.0.0-latest
        restart_policy: always
        volumes:
          - monitoring:/omd/sites
        ports:
          - "192.168.0.253:8080:5000"
        env:
          MAIL_RELAY_HOST: "192.168.0.253"
          CMK_SITE_ID: "cmk"
