---
- name: update docker compose stacks on docker1
  hosts: docker1.srv.3fr.uk
  gather_facts: false
  vars: 
    stack_name:
      - atuin
      - auth
      - immich
      - romm

  tasks:
    - name: pull latest containers on docker1
      ansible.builtin.command: 
        cmd: docker compose pull
        chdir: /home/scott/docker/{{ item }}
      loop: "{{ stack_name }}"
    - name: restart containers
      ansible.builtin.command: 
        cmd: docker compose up -d
        chdir: /home/scott/docker/{{ item }}
      loop: "{{ stack_name }}"
    - name: "Create CNAMEs"
      delegate_to: localhost
      loop: "{{ stack_name }}"
      sbarbett.pihole.local_cname:
        host: "{{ item }}.home.thunderweb.uk"
        target: "{{ inventory_hostname }}"
        state: present
        url: "https://pihole.home.thunderweb.uk"
        password: "{{ pihole_admin }}"